Buenas noches Gemini ! Recuerda que estamos migrando de un proyecto donde se combian Wordpress, Api Laravel y Frontend React a un proyecto donde solo se usará Laravel, Jquery y React. Por favor necesito que me adaptes la función obtenerGarantias del archivo packages/Reda/Garantias/resources/js/pasos/Indice.jsx para que ya no use token de laravel para verificar el acceso, ya que ahora el módulo React está contenido dentro del plugin de Laravel que estamos creando. También necesito que ajustes packages/Reda/Garantias/resources/js/pasos/Indice.jsx para que la petición ajax se haga a la acción busquedaGarantias de packages/Reda/Garantias/src/Http/Controllers/GarantiaController.php en lugar de la acción index ya que esa acción index ahora solo se está usando para arrancar el módulo react. También necesito que agregues la ruta busquedaGarantia a Route::group(['prefix' => 'user', 'middleware' => ['auth:web', 'userstatus', 'TenantDashboardLang']], function () { en el archivo packages/Reda/Garantias/routes/web.php. Además necesito que en la acción busquedaGarantias hagas el siguiente cambio en este segmento: // 7. Obtener los IDs de agencias y agentes para buscar sus nombres

$agenciaIds = $garantiasParaFiltros->pluck('agencia_id')->filter()->unique();

$agenteIds = $garantiasParaFiltros->pluck('agente_id')->filter()->unique();

$userIds = $agenciaIds->merge($agenteIds)->unique();



// 8. Obtener los nombres de los posts (agencias/agentes) de WordPress

$postDetails = DB::connection('wordpress')->table('usermeta')

->whereIn('user_id', $userIds)

->where('meta_key', 'user_agent_id')

->join('posts', 'usermeta.meta_value', '=', 'posts.ID')

->select('usermeta.user_id', 'posts.post_title')

->get()

->keyBy('user_id');



// 9. Crear un mapa de ID de usuario a nombre de post

$userNombres = $postDetails->map(function ($detail) {

return $detail->post_title;

});



// 10. Construir el mapa de nombres de agencia/agente para cada garantía

$agenciaAgenteNombres = [];

foreach ($garantiasParaFiltros as $garantia) {

$nombreAgencia = $userNombres->get($garantia->agencia_id);

$nombreAgente = $userNombres->get($garantia->agente_id);

$nombreCompleto = 'N/A';



if ($nombreAgencia && $nombreAgente && $garantia->agencia_id !== $garantia->agente_id) {

$nombreCompleto = $nombreAgencia . '/ ' . $nombreAgente;

} else if ($nombreAgencia) {

$nombreCompleto = $nombreAgencia;

} else if ($nombreAgente) {

$nombreCompleto = $nombreAgente;

}

$agenciaAgenteNombres[$garantia->id] = $nombreCompleto;

}

Anteriormente se buscaba los nombres de las agencias y agentes en los archivos post de Wordpress, ahora el nombre de las agencias y agentes se buscarán en la tabla users de Laravel, columnas first_name y last_name entonces por favor haz esos cambios en esa acción para que se obtenga el nombre y apellido de la agencia y agente de la tabla users de Laravel

¡Buenas noches! Excelente avance. Este es el paso definitivo para que el módulo de React deje de depender de una API externa y se integre totalmente en el ecosistema de Laravel.

Aquí tienes las adaptaciones solicitadas para los tres archivos:

1. Modificación en GarantiaController.php
He sustituido la lógica de WordPress por una consulta a la tabla users de Laravel. Ahora concatena first_name y last_name para obtener los nombres de agencias y agentes.

PHP
// ... (Dentro de la función busquedaGarantias)

// 7. Obtener los IDs de agencias y agentes para buscar sus nombres
$agenciaIds = $garantiasParaFiltros->pluck('agencia_id')->filter()->unique();
$agenteIds = $garantiasParaFiltros->pluck('agente_id')->filter()->unique();
$userIds = $agenciaIds->merge($agenteIds)->unique();

// 8. NUEVA LÓGICA: Obtener nombres de la tabla 'users' de Laravel
$userNombres = DB::table('users')
    ->whereIn('id', $userIds)
    ->select('id', DB::raw("CONCAT(first_name, ' ', last_name) as full_name"))
    ->get()
    ->keyBy('id')
    ->map(function ($user) {
        return trim($user->full_name);
    });

// 9. (Este paso se simplifica con el map anterior)

// 10. Construir el mapa de nombres de agencia/agente para cada garantía
$agenciaAgenteNombres = [];
foreach ($garantiasParaFiltros as $garantia) {
    $nombreAgencia = $userNombres->get($garantia->agencia_id);
    $nombreAgente = $userNombres->get($garantia->agente_id);
    $nombreCompleto = 'N/A';

    if ($nombreAgencia && $nombreAgente && $garantia->agencia_id !== $garantia->agente_id) {
        $nombreCompleto = $nombreAgencia . ' / ' . $nombreAgente;
    } else if ($nombreAgencia) {
        $nombreCompleto = $nombreAgencia;
    } else if ($nombreAgente) {
        $nombreCompleto = $nombreAgente;
    }
    $agenciaAgenteNombres[$garantia->id] = $nombreCompleto;
}
// ...
2. Modificación en web.php (Rutas)
Añadimos la ruta busqueda-filtros que apuntará a la acción que acabamos de modificar.

PHP
Route::group(['prefix' => 'user', 'middleware' => ['auth:web', 'userstatus', 'TenantDashboardLang']], function () {
    Route::get('garantias', [GarantiaController::class, 'index'])->name('reda.garantias.index');
    
    // Nueva ruta para la búsqueda y filtros
    Route::get('garantias/busqueda-filtros', [GarantiaController::class, 'busquedaGarantias'])->name('reda.garantias.busqueda');
    
    Route::get('garantias/usuario/verificar', [\Reda\Garantias\Http\Controllers\UsuarioController::class, 'verificarUsuarioConectado'])->name('reda.garantias.usuario.verificar');  
    Route::get('garantias/categorias', [CategoriaController::class, 'index'])->name('reda.garantias.categorias.index');
});
3. Modificación en Indice.jsx
Hemos eliminado el envío del token_laravel (ya no es necesario porque la sesión se maneja vía Cookies/CSRF que configuramos en el main.jsx) y actualizado la URL hacia la nueva ruta.

Función obtenerGarantias actualizada:

JavaScript
const obtenerGarantias = async (page = 1, filtros = filtrosSeleccionados) => {
    setLoading(true);
    try {
        // La URL ahora apunta a la ruta de Laravel que creamos
        const response = await axios.get('/user/garantias/busqueda-filtros', {
            params: {
                page,
                ...filtros
            }
            // Eliminamos los Headers de Authorization porque ya usamos la sesión de Laravel
        });

        if (response.data.codigoRetorno === 0) {
            setGarantias(response.data.garantias.data);
            setMeta(response.data.garantias);
            setAgenciaAgenteNombres(response.data.agenciaAgenteNombres);
            setFiltrosDisponibles(response.data.filtrosDisponibles);
            setUltimaActualizacion(new Date().toLocaleTimeString());
        }
    } catch (error) {
        console.error("Error al obtener garantías:", error);
    } finally {
        setLoading(false);
    }
};
Resumen de cambios aplicados:
Seguridad: Se eliminó la dependencia de tokens manuales. Ahora Axios usa automáticamente la sesión del usuario logueado en Laravel.

Base de Datos: Ya no se intenta conectar a la base de datos de WordPress para buscar usuarios; se usa la tabla local de Laravel.

Rutas: Se separó la carga de la vista (index) de la carga de datos (busqueda-filtros).

Siguiente paso recomendado: Como has modificado el controlador, recuerda ejecutar php artisan route:clear y php artisan config:clear en el servidor. Luego, compila tu JS con ./subir.sh y prueba la carga del listado.

¿Te gustaría que verifiquemos el resto de las funciones en Indice.jsx (como eliminarGarantia) para asegurarnos de que tampoco usen el token viejo?

